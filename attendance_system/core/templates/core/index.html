<!DOCTYPE html>
<html>
<head>
    <title>Smart Attendance System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --danger: #e74c3c; --bg: #eef2f3; }
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; background: var(--bg); margin: 0; padding: 10px; }
        .header-nav { width: 100%; max-width: 1400px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .nav-actions { display: flex; gap: 10px; align-items: center; }
        .container { display: flex; gap: 20px; width: 100%; max-width: 1400px; flex-wrap: wrap; }
        .video-box { flex: 2; min-width: 320px; border: 6px solid var(--primary); background: #000; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .log-box { flex: 1; min-width: 320px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 600px; display: flex; flex-direction: column; }
        .table-wrapper { overflow-y: auto; flex-grow: 1; margin: 10px 0; border: 1px solid #f0f0f0; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; font-size: 0.85em; }
        th { background: var(--primary); color: white; position: sticky; top: 0; }
        .session-select { padding: 10px; border-radius: 8px; border: 2px solid #eee; width: 100%; margin-top: 5px; font-weight: bold; }
        .btn { padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: bold; font-size: 0.85em; border: none; cursor: pointer; transition: 0.2s; }
        .btn-register { background: var(--accent); color: white; }
        .btn-export { background: var(--success); color: white; }
        .btn-close { background: var(--danger); color: white; width: 100%; padding: 12px; margin-top: 10px; }
        .badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75em; }
        .badge-start { background: #d4edda; color: #155724; }
        .badge-finish { background: #cce5ff; color: #004085; }
        .status-dot { height: 10px; width: 10px; background: var(--success); border-radius: 50%; display: inline-block; margin-right: 8px; }
    </style>
</head>
<body>
    <div class="header-nav">
        <h1>Attendance Dashboard</h1>
        <div class="nav-actions">
            <a href="{% url 'history' %}" class="btn" style="background: #9b59b6; color: white;">History</a>
            <a href="{% url 'register' %}" class="btn btn-register">+ Register</a>
            <a href="{% url 'assessment_report' %}" class="btn btn-export">Assessment</a>
            <form method="post" action="{% url 'admin:logout' %}">{% csrf_token %}<button type="submit" style="color:var(--danger); background:none; border:none; font-weight:bold; cursor:pointer;">Logout</button></form>
        </div>
    </div>
    
    <div class="container">
        <div class="video-box"><img src="{% url 'video_feed' %}" width="100%"></div>
        <div class="log-box">
            <div style="font-weight: bold; color: var(--primary);"><span class="status-dot"></span><span id="session-text">Live Monitoring</span></div>
            <select id="session-selector" class="session-select">
                {% for session in active_sessions %}<option value="{{ session.id }}">{{ session.name }}</option>
                {% empty %}<option value="">No Active Sessions</option>{% endfor %}
            </select>
            <div class="table-wrapper">
                <table>
                    <thead><tr><th>ID</th><th>Name</th><th>Action</th><th>Time</th></tr></thead>
                    <tbody id="attendance-table-body"></tbody>
                </table>
            </div>
            <button id="close-btn" class="btn btn-close">End Current Session</button>
            <a href="{% url 'export_csv' %}" class="btn" style="background:#eee; color:#333; text-align:center; margin-top:5px; font-size:0.7em;">Download Full CSV</a>
        </div>
    </div>

    <script>
        const selector = document.getElementById('session-selector');
        function updateAttendance() {
            const sessionId = selector.value;
            if(!sessionId) return;
            fetch(`/attendance-api/?session_id=${sessionId}`)
                .then(r => r.json()).then(data => {
                    const body = document.getElementById('attendance-table-body');
                    body.innerHTML = '';
                    document.getElementById('session-text').innerText = "Monitoring: " + data.session_name;
                    data.attendees.forEach(s => {
                        body.innerHTML += `<tr><td>${s.id}</td><td>${s.name}</td><td><span class="badge ${s.type == 'START' ? 'badge-start' : 'badge-finish'}">${s.type}</span></td><td>${s.time}</td></tr>`;
                    });
                });
        }
        document.getElementById('close-btn').onclick = function() {
            if(confirm("End this session?")) {
                fetch(`/close-session/${selector.value}/`, {method:'POST', headers:{'X-CSRFToken':'{{csrf_token}}'}})
                .then(() => location.reload());
            }
        };
        selector.onchange = updateAttendance;
        setInterval(updateAttendance, 3000);
        updateAttendance();
    </script>
</body>
</html>